## Context

当前 j-cli 的聊天功能中，用户可以通过 Ctrl+L 快捷键"清除对话"。这个功能会永久删除当前会话的所有消息历史，导致用户无法保留有价值的历史对话内容。

现有的清除对话功能实现：
- 位置：`src/command/chat/app.rs::clear_session()`
- 触发方式：`Ctrl+L` 快捷键
- 行为：清空 `session.messages`、重置滚动位置、清除缓存并保存空会话

用户反馈希望能够保留对话历史，同时清理当前会话显示。

## Goals / Non-Goals

**Goals:**
- 将"清除对话"重构为"归档对话"，允许用户保存当前对话历史
- 支持以日期（YYYY-MM-DD）作为默认归档名称
- 支持用户自定义归档名称
- 提供"还原归档对话"功能，可以从归档中恢复对话
- 还原对话后自动清除当前会话的历史记录，避免消息混乱
- 归档数据持久化存储

**Non-Goals:**
- 不实现多会话并发管理（如同时打开多个会话窗口）
- 不实现云同步或跨设备归档共享
- 不修改现有的聊天功能核心逻辑

## Decisions

### 1. 归档存储方案

**决定：** 使用本地文件系统存储归档

**理由：**
- 简单直接，无需引入外部依赖
- 用户数据完全本地控制，无隐私风险
- 归档文件可手动备份、分享
- 文件格式使用 JSON，便于人类阅读和迁移

**替代方案考虑：**
- SQLite 数据库：增加依赖，过度设计
- 远程存储：增加复杂度，不符合本地工具定位

**实现细节：**
- 归档目录：`~/.j/chat/archives/`
- 归档文件格式：`<name>.json`
- 文件内容：
  ```json
  {
    "name": "2026-02-25",
    "created_at": "2026-02-25T19:30:00Z",
    "messages": [
      {"role": "user", "content": "..."},
      {"role": "assistant", "content": "..."}
    ]
  }
  ```

### 2. 命令行快捷键变更

**决定：** 保持 `Ctrl+L` 作为归档对话快捷键

**理由：**
- 用户已有肌肉记忆
- 行为虽然变更，但功能目的一致（清理当前会话）

**交互流程：**
1. 用户按 `Ctrl+L`
2. 如果当前会话有消息，弹出提示：
   ```
   归档当前对话？
   默认名称: 2026-02-25
   [Enter] 确认 [n] 自定义名称 [Esc] 取消
   ```
3. 用户确认后归档，显示 "对话已归档: 2026-02-25"
4. 清空当前会话消息

### 3. 还原归档交互

**决定：** 使用 `Ctrl+R` 作为还原归档快捷键

**理由：**
- `R` 代表 Restore，语义清晰
- 与其他快捷键风格一致（Ctrl+L、Ctrl+T 等）

**交互流程：**
1. 用户按 `Ctrl+R`
2. 显示归档列表（支持滚动选择）
3. 用户选中后按 `Enter` 确认
4. 自动清除当前会话
5. 从归档恢复消息到当前会话
6. 显示 "已还原归档: 2026-02-25"

### 4. 数据结构设计

**决定：** 新增归档管理模块，独立于现有会话管理

**理由：**
- 职责分离：归档管理与会话管理解耦
- 易于测试和维护
- 未来扩展更容易（如归档删除、导出等）

**模块结构：**
```
src/command/chat/
├── archive.rs      (新增)
│   ├── ChatArchive     // 归档数据结构
│   ├── list_archives()
│   ├── create_archive()
│   ├── restore_archive()
│   └── delete_archive()
├── app.rs
├── model.rs
└── handler.rs
```

### 5. 归档命名策略

**决定：** 默认使用 `archive-` 前缀 + ISO 8601 日期格式，支持自定义

**理由：**
- 国际标准，易于排序和查找
- 与日期排序自然一致
- 用户友好
- `archive-` 前缀明确标识文件类型，便于文件管理
- 避免与其他可能的配置文件混淆

**默认名称生成规则：**
- 基础格式：`archive-YYYY-MM-DD`（如 `archive-2026-02-25`）
- 如果归档已存在，自动添加后缀：`archive-2026-02-25(1)`、`archive-2026-02-25(2)` 等
- 后缀从 (1) 开始递增，直到找到可用的名称

**自定义名称限制：**
- 不能包含 `/` `\` `:` `*` `?` `"` `<` `>` `|` 等非法文件名字符
- 最大长度 50 字符（包括 `archive-` 前缀）
- 不能与现有归档同名（会提示覆盖或取消）

## Risks / Trade-offs

**Risk 1: 归档数据丢失**
- 风险：用户删除归档文件或清理目录导致数据丢失
- 缓解：归档文件使用 JSON 格式，用户可手动备份；提供警告提示

**Risk 2: 归档文件损坏**
- 风险：文件系统故障或异常写入导致 JSON 损坏
- 缓解：归档前验证 JSON 序列化；读取时添加容错处理

**Trade-off: 功能复杂度 vs 用户体验**
- 当前设计简化了归档管理（无删除、导出功能），但提供了核心能力
- 未来可以扩展，如归档删除、批量操作、搜索等

**Trade-off: 默认名称 vs 自由命名**
- 使用日期作为默认名称，牺牲了灵活性但提升了易用性
- 用户仍可自定义，满足特殊需求

## Migration Plan

### 部署步骤

1. **创建归档目录**
   - 应用启动时检查并创建 `~/.j/chat/archives/` 目录

2. **重构 clear_session 方法**
   - 改名为 `archive_session_with_default_name()`
   - 保持原有清理逻辑，增加归档步骤

3. **新增 archive_session 方法**
   - 支持自定义名称参数
   - 处理命名冲突（提示覆盖或取消）

4. **新增 restore_session 方法**
   - 显示归档列表供选择
   - 清空当前会话
   - 加载归档消息

5. **更新快捷键处理**
   - `Ctrl+L`: 调用归档逻辑（带交互）
   - `Ctrl+R`: 调用还原逻辑

6. **更新帮助文档**
   - 说明 `Ctrl+L` 现在是归档对话
   - 说明 `Ctrl+R` 是还原归档

### 回滚策略

- 保留原有 `clear_session()` 方法实现逻辑
- 如需回滚，恢复方法名和快捷键映射
- 归档文件不影响原有功能运行

## Open Questions

1. **归档数量限制？**
   - 建议：暂不限制，依赖用户自行管理
   - 可在 future 考虑增加归档自动清理策略

2. **归档文件大小限制？**
   - 建议：暂不限制，对话内容通常不大
   - 可在 future 考虑归档压缩或分片

3. **是否需要归档预览？**
   - 建议：在归档列表中显示消息数量和日期
   - 可在 future 考虑显示最后一条消息摘要
